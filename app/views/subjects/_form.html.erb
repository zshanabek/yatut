<%= form_with(model: subject, local: true) do |form| %>
<% if subject.errors.any? %>
  <div id="error_explanation">
    <h2><%= pluralize(subject.errors.count, "error") %> prohibited this subject from being saved:</h2>

    <ul>
    <% subject.errors.full_messages.each do |message| %>
      <li><%= message %></li>
    <% end %>
    </ul>
  </div>
<% end %>
<div class="col-md-4">
<div class="field">
  <%= form.label 'Название' %>
  <%= form.text_field :name, class: "form-control", required: true%>
</div>
<div class="field">
  <%= form.hidden_field :latitude, id: "latitude", required: true %>
</div>


<div class="field">
  <%= form.hidden_field :longitude, id: "longitude", required: true %>
</div>

<div class="field">
  <%= form.label 'Радиус' %>
  <%= form.number_field :radius, class: "form-control", id:"radius", required: true %>
</div>


<div style='width: 348; margin-top: 20px;'>
  <div id="map" style='width: 348px; height: 348px;'></div>
</div>


<div class="actions">
  <%= form.submit 'Создать предмет', style:"margin: 20px 0 20px 0;", class:"btn btn-primary form-control", id:"submit_button"  %>
</div>

<% end %>
</div>

<script>

function initMap() {
  var marker;
  var circle;
  var radius;
  var map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: -34.397, lng: 150.644},
    zoom: 15
  });
  var infoWindow = new google.maps.InfoWindow({map: map});

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      infoWindow.setPosition(pos);
      infoWindow.setContent('Найдено ваше местоположение. Выберите центр аудитории');
      map.setCenter(pos);
      map.setZoom(15);
    }, function() {
      handleLocationError(true, infoWindow, map.getCenter());
    });
  } else {
    handleLocationError(false, infoWindow, map.getCenter());
  }


  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.');
  }
  map.addListener('click', function(e){
    placeMarkerAndPanTo(e.latLng, map);
  });
  function placeMarkerAndPanTo(latLng, map){
    if ( marker ) {
      marker.setPosition(latLng);
    }
    else{
      marker = new google.maps.Marker({
        position: latLng,
        map: map,
        draggable:true
      });
    }
    bindWithFields(latLng);
    map.panTo(latLng);
    if (circle){
      circle.setRadius(radius)
    }
    else{
      circle = new google.maps.Circle({
        map: map,
        radius: radius,
        strokeColor: '#FF0000'
      });
      circle.bindTo('center', marker, 'position');
    }
  }
  function bindWithFields(latLng){
    document.getElementById('longitude').value = latLng.lng()
    document.getElementById('latitude').value = latLng.lat()
  }

  document.getElementById("radius").addEventListener('change', doThing);
  function doThing(){
    radius = Number(this.value);
    console.log(radius);
  }
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBj_0GBAd1mmKjDg9M2wHE4YoFF9J2-1hA&callback=initMap" async defer>
</script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>

